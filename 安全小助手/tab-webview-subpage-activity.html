<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style type="text/css">
			.item-class {
				float: right;
			}
			
			.mui-navigate-right {
				color: black;
				font-size: medium;
			}
			
			.mui-badge {
				width: auto;
				height: auto;
				color: #0062CC;
				background: #0062CC;
				font-size: x-small;
				float: right;
			}
			
			.mui-table-cell div{
				float: left
			}
		</style>
	</head>

	<body>
		<div class="mui-content" id="main">
			<ul id="activity" class="mui-table-view">
			</ul>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/mui.picker.js"></script>
		<script src="js/mui.poppicker.js"></script>
		<script src="js/bmob-min.js"></script>
		<script src="js/bomb.js"></script>
		<script type="text/javascript">
			var userClass;
			var companyId;
			var userId;
			var subsidiaryId;
			var supervisionCompanyId;
			var baseUrl = "http://123.206.87.22";
			var length;
			var length_;
			var actInfo;
			
			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					backButtonPress++;
					if(backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				var self = plus.webview.currentWebview();
				userClass = self.userClass;
				companyId = self.companyId;
				userId = self.userId;
				subsidiaryId = self.subsidiaryId;
				supervisionCompanyId = self.supervisionCompanyId;
				var request_url = baseUrl + "/user/activityList?companyId=" + companyId;
				console.log(request_url);
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8'
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						var actList = extend.list;
						actInfo = actList;
						length = actList.length;
						var count = 0;
						for(var i = 0; i < actList.length; i++) {
							var activityId = actList[i].activityId;
							var activityDate = actList[i].activityDate;
							var activityTitle = actList[i].activityTitle;
							var activityContent = actList[i].activityContent;
							var activityAppendixPath = actList[i].activityAppendixPath;
							var activityCategoryId = actList[i].activityCategoryId;
							var activityCategoryName = actList[i].activityCategory.activityCategoryName;
							if(localStorage.getItem("user-act" + userId + activityId) == undefined || localStorage.getItem("user-act" + userId + activityId) == null) {
								localStorage.setItem("user-act" + userId + activityId, "0");
								count += 1;
							} else if(localStorage.getItem("user-act" + userId + activityId) == "0") {
								count += 1;
							}
							if(count > 0) {
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_1", {
									state: "1"
								});
							} else {
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_1", {
									state: "0"
								});
							}
							length_ = count;
							addAct(activityId, activityTitle, activityDate, activityContent, activityAppendixPath, activityCategoryId, activityCategoryName);
						}

					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			});

			mui('.mui-table-view').on('tap', '.mui-table-view-cell', function(e) {
				if(length_ > 0)
					length_ -= 1;
				var node = this.childNodes;
				var node_ = node[0];
				var title = node_.getAttribute("id");
				console.log(title);
				console.log(node_.innerHTML);
				var node__ = node_.childNodes;
				var date = node__[1].getElementsByClassName("mui-ellipsis")[0].innerHTML;
				var content = node[3].value;
				var activityAppendixPath = node[1].value;
				var id = node[2].value;
				var cat = node[4].value;
				console.log(cat);
				if(localStorage.getItem("user-act" + userId + id) == "0") {
					localStorage.setItem("user-act" + userId + id, "1");
//					document.getElementById(id).style.display = "none";
					var img = document.getElementById("user-act" + userId + id);
					console.log(img.src);
					if(cat == "通知通报"){
						img.src = "image/attention.png";	
					}else if(cat == "安全新闻"){
						img.src = "image/news.png";
					}else if(cat == "文件转发"){
						img.src = "image/act.png";
					}else{
						img.src = "image/chat.png";
					}
					
				}
				mui.openWindow({
					url: "activity_content.html",
					id: "activity_content",
					extras: {
						title: title,
						date: date,
						content: content,
						activityAppendixPath: activityAppendixPath
					}
				});
			});			
			
			function addAct(id, title, date, content, activityAppendixPath, activityCategoryId, activityCategoryName) {
				var ul = document.getElementById("activity");
				var liObj = document.createElement("li");
				var a = document.createElement("a");
				var img = document.createElement("img");
				var div = document.createElement("div");
				var p = document.createElement("p");
				liObj.setAttribute("class", "mui-table-view-cell mui-media");
				img.setAttribute("class", "mui-media-object mui-pull-left");
				img.setAttribute("id", "user-act" + userId + id);
				if(activityCategoryName == "通知通报"){
					img.src = "image/attention.png";	
				}else if(activityCategoryName == "安全新闻"){
					img.src = "image/news.png";
				}else if(activityCategoryName == "文件转发"){
					img.src = "image/act.png";
				}else{
					img.src = "image/chat.png";
				}
				var div = document.createElement("div");
				div.setAttribute("class", "mui-media-body");
				a.setAttribute("id", title);
				div.innerHTML = title;
				p.setAttribute("class", "mui-ellipsis");
				p.innerHTML = convUnixTimestamp(date);
				if(localStorage.getItem("user-act" + userId + id) == "0") {
//					a.innerHTML = a.innerHTML + "<span id=\"" + id + "\" class=\"mui-badge mui-badge-primary\">s</span>";
					if(activityCategoryName == "通知通报"){
						img.src = "image/re_attention.png";	
					}else if(activityCategoryName == "安全新闻"){
						img.src = "image/re_news.png";
					}else if(activityCategoryName == "文件转发"){
						img.src = "image/re_act.png";
					}else{
						img.src = "image/re_chat.png";
					} 
				}
				a.appendChild(img);
				div.innerHTML = title;
				div.appendChild(p);
				a.appendChild(div);
				liObj.appendChild(a);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "activityAppendixPath";
				hidden_input.value = activityAppendixPath;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = id;
				hidden_input.value = id;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "content";
				hidden_input.value = content;
				liObj.appendChild(hidden_input);				
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "activityCategoryName";
				hidden_input.value = activityCategoryName;
				liObj.appendChild(hidden_input);				
				ul.appendChild(liObj);
			}

			function convUnixTimestamp(timeStamp) {
				var date = new Date(parseInt(timeStamp));
				var Y = date.getFullYear() + '-';
				var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
				var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' ';
				var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
				var m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
				var s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds());
				return Y + M + D + h + m + s;
			}

			window.addEventListener("refresh_", function() {
				if(length_ == 0) {
					var parent = plus.webview.getWebviewById("main");
					mui.fire(parent, "update_1", {
						state: "0"
					});
				}
				console.log(length);
				console.log(companyId);
				if(companyId == undefined)
					return;
				var request_url = baseUrl + "/activityCount?companyId=" + companyId;
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						if(extend.activityCount != length) {
							location.reload();
						}
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			});
		</script>
	</body>

</html>