<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style type="text/css">
			.item-class {
				float: right;
			}
			
			.mui-navigate-right {
				color: black;
				font-size: medium;
			}
			
			.mui-badge {
				padding: 0px;
				font-size: xx-small;
				float: right;
				margin: 5px;
			}
		</style>
	</head>

	<body>
		<div id="main" id="pullrefresh" class="mui-content">
			<div class="mui-scroll">
				<ul id="activity" class="mui-table-view mui-table-view-chevron">
				</ul>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/mui.picker.js"></script>
		<script src="js/mui.poppicker.js"></script>
		<script src="js/bmob-min.js"></script>
		<script src="js/bomb.js"></script>
		<script type="text/javascript">
			var userClass;
			var companyId;
			var userId;
			var subsidiaryId;
			var supervisionCompanyId;
			var baseUrl = "http://123.206.87.22";
			var length;
			var length_;
			var actInfo;
			
			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					backButtonPress++;
					if(backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				var self = plus.webview.currentWebview();
				userClass = self.userClass;
				companyId = self.companyId;
				userId = self.userId;
				subsidiaryId = self.subsidiaryId;
				supervisionCompanyId = self.supervisionCompanyId;
				var request_url = baseUrl + "/user/activityList?companyId=" + companyId;
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8'
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						var actList = extend.list;
						actInfo = actList;
						length = actList.length;
						var count = 0;
						for(var i = 0; i < actList.length; i++) {
							var activityId = actList[i].activityId;
							var activityDate = actList[i].activityDate;
							var activityTitle = actList[i].activityTitle;
							var activityContent = actList[i].activityContent;
							var activityAppendixPath = actList[i].activityAppendixPath;
							var activityCategoryId = actList[i].activityCategoryId;
							if(localStorage.getItem("user-act" + userId + activityId) == undefined || localStorage.getItem("user-act" + userId + activityId) == null) {
								localStorage.setItem("user-act" + userId + activityId, "0");
								count += 1;
							} else if(localStorage.getItem("user-act" + userId + activityId) == "0") {
								count += 1;
							}
							if(count > 0) {
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_1", {
									state: "1"
								});
							} else {
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_1", {
									state: "0"
								});
							}
							length_ = count;
							addAct(activityId, activityTitle, activityDate, activityContent, activityAppendixPath);
						}

					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			});

			mui('.mui-table-view').on('tap', '.mui-table-view-cell', function(e) {
				if(length_ > 0)
					length_ -= 1;
				var node = this.childNodes;
				var title = node[0].getAttribute("id");
				var date = node[1].innerHTML;
				var content = node[2].innerHTML;
				var activityAppendixPath = node[3].value;
				var id = node[4].value;
				if(localStorage.getItem("user-act" + userId + id) == "0") {
					localStorage.setItem("user-act" + userId + id, "1");
					document.getElementById(id).style.display = "none";
				}
				mui.openWindow({
					url: "activity_content.html",
					id: "activity_content",
					extras: {
						title: title,
						date: date,
						content: content,
						activityAppendixPath: activityAppendixPath
					}
				});
			});

			function addAct(id, title, date, content, activityAppendixPath) {
				var ul = document.getElementById("activity");
				var liObj = document.createElement("li");
				var a = document.createElement("p");
				var p1 = document.createElement("p");
				var p2 = document.createElement("p");
				liObj.setAttribute("class", "mui-table-view-cell");
				a.setAttribute("class", "mui-navigate-right");
				a.setAttribute("id", title);
				a.innerHTML = title;
				p1.innerHTML = convUnixTimestamp(date);
				p2.innerHTML = content;
				p2.setAttribute("hidden", 'true');
				liObj.appendChild(a);
				liObj.appendChild(p1);
				liObj.appendChild(p2);
				//				<span class="mui-badge mui-badge-primary">12</span>
				if(localStorage.getItem("user-act" + userId + id) == "0") {
					a.innerHTML = a.innerHTML + "<span id=\"" + id + "\" class=\"mui-badge mui-badge-primary\">&nbsp;</span>";
				}
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "activityAppendixPath";
				hidden_input.value = activityAppendixPath;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = id;
				hidden_input.value = id;
				liObj.appendChild(hidden_input);
				ul.appendChild(liObj);
			}

			function convUnixTimestamp(timeStamp) {
				var date = new Date(parseInt(timeStamp));
				var Y = date.getFullYear() + '-';
				var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
				var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' ';
				var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
				var m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
				var s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds());
				return Y + M + D + h + m + s;
			}

			window.addEventListener("refresh_", function() {
				if(length_ == 0) {
					var parent = plus.webview.getWebviewById("main");
					mui.fire(parent, "update_1", {
						state: "0"
					});
				}
				console.log(length);
				console.log(companyId);
				if(companyId == undefined)
					return;
				var request_url = baseUrl + "/activityCount?companyId=" + companyId;
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						if(extend.activityCount != length) {
							location.reload();
						}
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			});
		</script>
	</body>

</html>