<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/feedback.css" rel="stylesheet" />
		<style>
			body{
				text-align: center;
			}
			.mui-bar {
				background: #555555;
			}
			
			.mui-icon{
				color: #fff;
			}
			
			label{
				color: #0062CC;
			}			
			
			.mui-title{
				color: #fff;
			}
			
			.mui-content-padded {
				margin-top: 30px;
			}
			
			.pic {
				margin-right: 10px;
			}
			
			#main{
				margin-top: 10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="close" class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">安全隐患排查处置表</h1>
		</header>
		<div id="main"  class="mui-content">
			<form id="upload" action="http://106.14.122.40/user/danger" method="post" class="mui-input-group" enctype="multipart/form-data">
				<div>
					<input id="1" type="hidden" name="userId">
					<input id="2" type="hidden" name="companyId">
					<input id="3" type="hidden" name="subsidiaryId">
				</div>
				<div class="mui-input-row">
					<label>隐患部位</label>
					<input id='position' name="dangerPosition" type="text" class="mui-input-clear mui-input" placeholder="请输入隐患部位">
				</div>
				<div class="mui-input-row">
					<label>隐患描述</label>
				</div>
				<div class="mui-input-speech">
					<textarea id="description" rows="3" placeholder="请输入隐患描述" name="dangerDescription"></textarea>
				</div>
				<div class="mui-input-row">
					<label>隐患截图</label>
					<input id='pic' name="dangerImg" type="file" class="mui-input-clear mui-input" placeholder="点击添加隐患截图">
				</div>
				<div class="mui-content-padded">
					<button style="visibility: hidden;" type="submit" class="mui-btn-green mui-btn-block mui-btn-primary" >提交</button>
				</div>
			</form>
			<!--<p>点击空白区域添加图片(提供隐患截图)</p>
			<div id='image-list' class="row image-list">
			</div>-->
			<div id="tip" style="display: none;">
				<p style="font-size: 1em;">
					正在上传......
				</p>
			</div>			
			<div class="mui-content-padded">
				<button id='submit' class="mui-btn-block mui-btn-primary">提交</button>
			</div>
			
			<!--<div class="mui-content-padded">
				<button id='test_bt' class="mui-btn-block mui-btn-primary">test</button>
			</div>			-->
			
			<img src="" id="test"/>
		</div>
		<script src="js/jquery.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/photo.js"></script>
		<script type="text/javascript">
			var id_;
			var class_;
			var userId;
			var companyId;
			var mark = false;
			var baseurl = "http://106.14.122.40/";
			
			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					plus.webview.currentWebview().close();
				};
				var self = plus.webview.currentWebview();
				id_ = self.id_;
				class_ = self.class_;
				userId = self.userId;
				companyId = self.companyId;
				console.log(id_);
				console.log(class_);
				console.log(companyId);
				document.getElementById("1").value = userId;
				document.getElementById("2").value = companyId;
				document.getElementById("3").value = id_;
			});
			
			mui.init();

			document.getElementById("close").addEventListener("tap", function() {
				plus.webview.currentWebview().close();
			});

			document.getElementById("submit").addEventListener("tap", function() {
//				console.log(baseurl + "user/danger");
				if(document.getElementById("position").value == ""){
					plus.nativeUI.toast("请输入隐患部位");
				}else if(document.getElementById("description").value == ""){
					plus.nativeUI.toast("请输入隐患描述");
				}else if(document.getElementById("pic").value == ""){
					plus.nativeUI.toast("请添加隐患图片");
				}else{
					var bt_submit = document.getElementById("submit");
					bt_submit.disabled = "true";
					document.getElementById("tip").style.display = "inline";
					document.getElementById("1").value = userId;
					console.log(userId);
					document.getElementById("2").value = companyId;
					document.getElementById("3").value = id_;
					$.ajax({
					    url: baseurl + "user/danger",
					    type: 'POST',
					    cache: false,
					    data: new FormData($('#upload')[0]),
					    processData: false,
					    contentType: false
					}).done(function(res) {
						plus.nativeUI.toast("上传成功");
						location.reload();
					}).fail(function(res) {
						console.log(JSON.stringify(res));
						location.reload();
						plus.nativeUI.toast("上传失败！请选择小于5M的图片上传");
					});					
				}
			})
		</script>
	</body>

</html>