<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/feedback.css" rel="stylesheet" />
		<style>
			.mui-bar {
				background: #4cd964;
			}
			
			.mui-content-padded {
				margin-top: 30px;
			}
			
			.pic {
				margin-right: 10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="close" class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">安全隐患排查处置表</h1>
		</header>
		<div id="main" class="mui-content mui-scroll-wrapper">
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label>隐患部位</label>
					<input id='position' type="text" class="mui-input-clear mui-input" placeholder="请输入隐患部位">
				</div>
				<div class="mui-input-row">
					<label>隐患名称</label>
					<input id='name' type="text" class="mui-input-clear mui-input" placeholder="请输入隐患名称">
				</div>
				<div class="mui-input-row">
					<label>隐患描述</label>
					<input id='description' type="text" class="mui-input-clear mui-input" placeholder="请输入隐患描述">
				</div>
			</form>
			<p>点击空白区域添加图片(提供隐患截图)</p>
			<div id='image-list' class="row image-list">
			</div>
			<div class="mui-content-padded">
				<button id='submit' class="mui-btn-green mui-btn-block mui-btn-primary" onclick="submit()">提交</button>
			</div>
		</div>
		<script src="js/bmob.js"></script>
		<script src="js/bmob-min.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/photo.js"></script>
		<script type="text/javascript">
			var dangerId;
			var mark = false;
			var imgContenter = document.getElementById("image-list");

			mui('.image-list').on('tap', '.pic', function(e) {
				mark = true;
				imgContenter.removeChild(this);
			});
			
			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					plus.webview.currentWebview().close();
				};
				var self = plus.webview.currentWebview();
				dangerId = self.id;
			});
			mui.init();

			document.getElementById("close").addEventListener("tap", function() {
				plus.webview.currentWebview().close();
			});

			document.getElementById('image-list').addEventListener('tap', function() {
				if(mark){
					mark = false;
					return;
				}
				if(mui.os.plus) {
					var a = [{
						title: "拍照"
					}, {
						title: "从手机相册选择"
					}];
					plus.nativeUI.actionSheet({
						title: "隐患截图",
						cancel: "取消",
						buttons: a
					}, function(b) { /*actionSheet 按钮点击事件*/
						switch(b.index) {
							case 0:
								break;
							case 1:
								getImage(); /*拍照*/
								break;
							case 2:
								galleryImg(); /*打开相册*/
								break;
							default:
								break;
						}
					})
				}
			}, false);

			function getImage() {
				var c = plus.camera.getCamera();
				c.captureImage(function(e) {
					plus.io.resolveLocalFileSystemURL(e, function(entry) {
						var s = entry.toLocalURL() + "?version=" + new Date().getTime();
						addImg(s);
					}, function(e) {
						console.log("读取拍照文件错误：" + e.message);
					});
				}, function(s) {
					console.log("error:" + s);
				}, {
					
				})
			};

			//本地相册选择 
			function galleryImg() {
				plus.gallery.pick(function(a) {
					plus.io.resolveLocalFileSystemURL(a, function(entry) {
						plus.io.resolveLocalFileSystemURL("_doc/", function(root) {
							root.getFile("pic.png", {}, function(file) {
								//文件已存在 
								file.remove(function() {
									console.log("file remove success");
									entry.copyTo(root, 'pic.png', function(e) {
											var e = e.fullPath + "?version=" + new Date().getTime();
											addImg(e);
										},
										function(e) {
											console.log('copy image fail:' + e.message);
										});
								}, function() {
									console.log("delete image fail:" + e.message);
								});
							}, function() {
								//文件不存在 
								entry.copyTo(root, 'pic.png', function(e) {
										var path = e.fullPath + "?version=" + new Date().getTime();
										addImg(path);
									},
									function(e) {
										console.log('copy image fail:' + e.message);
									});
							});
						}, function(e) {
							console.log("fail");
						})
					}, function(e) {
						console.log("读取拍照文件错误：" + e.message);
					});
				}, function(a) {}, {
					filter: "image"
				})
			};

			function submit() {
				var position = document.getElementById("position").value;
				var name = document.getElementById("name").value;
				var description = document.getElementById("description").value;
				var danger_class = document.getElementById("danger_class").value;
				var view = document.getElementById('view').value;
				var time = document.getElementById('time').value;
				var solve_state = document.getElementById('solve_state').value;
				var person = document.getElementById('person').value;
				if(position == "") {
					plus.nativeUI.toast("请输入隐患部位");
				} else if(name == "") {
					plus.nativeUI.toast("请输入隐患名称");
				} else if(description == "") {
					plus.nativeUI.toast("请输入隐患描述");
				} else if(view == "") {
					plus.nativeUI.toast("请输入处理意见");
				} else if(time == "") {
					plus.nativeUI.toast("请输入整改期限");
				} else if(person == "") {
					plus.nativeUI.toast("请输入责任人姓名");
				} else {
					Bmob.initialize("3af36b72fde1e7e82511f7fbff079aad", "17b6f310b41b257cf6c73b4037ad6e41");
					var Hiddendanger = Bmob.Object.extend("Hiddendanger");
					var hiddendanger = new Hiddendanger();
					hiddendanger.set("position", position);
					hiddendanger.set("description", description);
					hiddendanger.set("name", name);
					hiddendanger.set("danger_class", danger_class);
					hiddendanger.set("view", view);
					hiddendanger.set("solve_state", solve_state);
					hiddendanger.set("person", person);
					hiddendanger.set("proName", project_name);
					hiddendanger.save(null, {
						success: function(object) {
							plus.nativeUI.toast("提交成功");
							location.reload();
							mui.fire(plus.webview.getWebviewById("tab-webview-subpage-focus.html"), "refresh");
						},
						error: function(model, error) {
							plus.nativeUI.toast("提交失败");
						}
					});
				}
			}

			function addImg(path) {
				var mainimg = document.createElement("img");
				mainimg.setAttribute("class", "pic");
				mainimg.src = path;
				mainimg.width = 60;
				mainimg.height = 60;
				imgContenter.appendChild(mainimg);
			}
		</script>
	</body>

</html>