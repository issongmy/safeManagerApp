<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
			body {
				text-align: center;
				background: white;
			}
			
			#icon {
				position: fixed;
				right: 10px;
				bottom: 20px;
			}
			
			p {
				color: black;
			}
			
			#logo{
				margin-top: 100px;
			}
		</style>
	</head>

	<body>
		<div id="logo">
			<img src="image/logo.png" width="100px"/>
		</div>
		<div id="icon">
			安全管理系统
		</div>
		<script src="js/bmob-min.js"></script>
		<script src="js/bmob.js"></script>
		<script src="js/mui.min.js"></script>
		<script>
			var baseurl = "http://123.206.87.22/";

			function skip() {
				ph = localStorage.getItem("username");
				pa = localStorage.getItem("pass");
				console.log(ph);
				console.log(pa);
				if(ph == null || pa == null) {
					console.log("Hi");
					mui.openWindow({
						url: "login.html",
						id: "login"
					});
					return;
				}
				var all = plus.webview.all();
				console.log(all.length);
				confirm_auto(ph, pa);
			}

			window.addEventListener('close', function(event) {
				plus.webview.currentWebview().close();
			});

			mui.plusReady(function() {
				setTimeout("skip()", 1000);
			});
			
			window.addEventListener('refresh', function(event) {
				location.reload();
			});
			
			function confirm_auto(ph, pa) {
					url = baseurl + "userLogin";
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					var data = {
						'userName': ph,
						'userPass': pa
					};
					mui.ajax(url, {
						type: "post",
						data: data,
						success: function(result) {
							var extend = eval(result.extend);
							console.log(result.code);
							var user = extend.user;
							mui.openWindow({
								url:"tab-webview-main.html",
								id:"main",
								extras:{
									userId:user.userId,	
									userName: user.userName,
									userClass:user.userCategory,
									companyId:user.companyId,
									subsidiaryId:user.subsidiaryId,
									supervisionCompanyId:user.supervisionCompanyId,
									companyName:user.company.companyName,
									subsidiaryName:user.subsidiary.subsidiaryName,
									supervisionCompanyName:user.supervisionCompany.supervisionCompanyName
								}
							});
						},
						error: function() {
							plus.nativeUI.toast("登录失败!");
						}
					});
			}
		</script>
	</body>

</html>