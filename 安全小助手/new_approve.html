<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style type="text/css">
			.mui-bar {
				background: #555555;
			}
			
			.mui-icon {
				color: #fff;
			}
			
			.mui-title {
				color: #fff;
			}
			
			.item-class {
				float: right;
			}
			
			.mui-navigate-right {
				color: black;
				font-size: medium;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="close" class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">新的审批</h1>
		</header>
		<div class="mui-content">
			<div class="mui-card">
				<ul id="main" class="mui-table-view mui-table-view-chevron">
				</ul>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript">
			var userClass;
			var companyId;
			var userId;
			var subsidiaryId;
			var supervisionCompanyId;
			var companyName;
			var subsidiaryName;
			var supervisionCompanyName;
			var baseUrl = "http://106.14.122.40";
			var eduBadge;
			var testBadge;
			var dangerBadge;
			var instituteBadge;
			var specialStaffBadge;
			var dataBadge;
			var preplanBadge;
			var responsibilityBadge;
			var majorStaffBadge;

			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					var parent = plus.webview.getWebviewById("tab-webview-subpage-my");
					var safe_num = 0;
					for(var i = 1; i <= 5; i++) {
						var li = document.getElementById((i+3).toString());
						if(li.getElementsByTagName("span")[0] == undefined)
							continue;
						var num = li.getElementsByTagName("span")[0].innerHTML;
						console.log(num);
						safe_num = safe_num + parseInt(num);
					}
					mui.fire(parent, "refresh", {
						safe_num: safe_num,
						id: "approve"
					});
					plus.webview.currentWebview().close();
				};
				var self = plus.webview.currentWebview();
				var self = plus.webview.currentWebview();
				userClass = self.userClass;
				companyId = self.companyId;
				userId = self.userId;
				subsidiaryId = self.subsidiaryId;
				supervisionCompanyId = self.supervisionCompanyId;
				companyName = self.companyName;
				subsidiaryName = self.subsidiaryName;
				supervisionCompanyName = self.supervisionCompanyName;
				console.log(userClass);
				if(userClass == "301") {
					var request_url = baseUrl + "/company/badge?companyId=" + companyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							eduBadge = extend.eduBadge;
							testBadge = extend.testBadge;
							dangerBadge = extend.dangerBadge;
							instituteBadge = extend.instituteBadge;
							specialStaffBadge = extend.specialStaffBadge;
							dataBadge = extend.dataBadge;
							preplanBadge = extend.preplanBadge;
							responsibilityBadge = extend.responsibilityBadge;
							majorStaffBadge = extend.majorStaffBadge;
							if(userClass == "101" || userClass == "301" || userClass == "201" || userClass == "401") {
								addItem("安全隐患", "1", dangerBadge);
							}
							if(userClass == "301" || userClass == "201" || userClass == "401") {
								addItem("三级教育", "2", eduBadge);
								addItem("安全交底", "3", testBadge);
							}
							if(userClass == "301" || userClass == "401"){
								addItem("组织结构", "4", instituteBadge);
								addItem("岗位职责", "5", responsibilityBadge);
								addItem("应急预案", "6", preplanBadge);
								addItem("专职人员", "7", majorStaffBadge);
								addItem("特种人员", "8", specialStaffBadge);
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "101") {
					var request_url = baseUrl + "/subsidiary/badge?subsidiaryId=" + subsidiaryId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							dangerBadge = extend.dangerBadge;
							addItem("安全隐患", "1", dangerBadge);
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "201") {
					var request_url = baseUrl + "/supervisionCompany/badge?supervisionCompanyId=" + supervisionCompanyId + "&companyId=" + companyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							eduBadge = extend.eduBadge;
							testBadge = extend.testBadge;
							dangerBadge = extend.dangerBadge;
							instituteBadge = extend.instituteBadge;
							specialStaffBadge = extend.specialStaffBadge;
							preplanBadge = extend.preplanBadge;
							responsibilityBadge = extend.responsibilityBadge;
							majorStaffBadge = extend.majorStaffBadge;
							if(userClass == "101" || userClass == "201" || userClass == "301" || userClass == "401") {
								addItem("安全隐患", "1", dangerBadge);
							}
							if(userClass == "201" || userClass == "301" || userClass == "401") {
									addItem("三级教育", "2", eduBadge);
									addItem("安全交底", "3", testBadge);
							}
							if(userClass == "301" || userClass == "401")
								if(instituteBadge >= 0){
									addItem("组织结构", "4", instituteBadge);
									addItem("岗位职责", "5", responsibilityBadge);
									addItem("应急预案", "6", preplanBadge);
									addItem("专职人员", "7", majorStaffBadge);
									addItem("特种人员", "8", specialStaffBadge);									
								}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "401") {
					var request_url = baseUrl + "/director/badge?companyId=" + companyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							eduBadge = extend.eduBadge;
							testBadge = extend.testBadge;
							dangerBadge = extend.dangerBadge;
							instituteBadge = extend.instituteBadge;
							specialStaffBadge = extend.specialStaffBadge;
							preplanBadge = extend.preplanBadge;
							responsibilityBadge = extend.responsibilityBadge;
							majorStaffBadge = extend.majorStaffBadge;
							if(userClass == "101" || userClass == "201" || userClass == "301" || userClass == "401") {
								addItem("安全隐患", "1", dangerBadge);
							}
							if(userClass == "201" || userClass == "301" || userClass == "401") {
								addItem("三级教育", "2", eduBadge);
								addItem("安全交底", "3", testBadge);
							}
							if(userClass == "301" || userClass == "401") {
								addItem("组织结构", "4", instituteBadge);
								addItem("岗位职责", "5", responsibilityBadge);
								addItem("应急预案", "6", preplanBadge);
								addItem("专职人员", "7", majorStaffBadge);
								addItem("特种人员", "8", specialStaffBadge);
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
			});

			mui("#main").on("tap", ".mui-table-view-cell", function() {
				var class_ = this.id;
				if(class_ == "1") {
					mui.openWindow({
						url: "safe_danger_approve.html",
						id: "safe_danger_approve",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				} else if(class_ == "2") {
					mui.openWindow({
						url: "three_edu_approve.html",
						id: "three_edu_approve",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				} else if(class_ == "3") {
					mui.openWindow({
						url: "safe_edu_approve.html",
						id: "safe_edu_approve",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				} else if(class_ == "4") {
					mui.openWindow({
						url: "info_1.html",
						id: "info_1",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				} else if(class_ == "5") {
					mui.openWindow({
						url: "info_2.html",
						id: "info_2",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				} else if(class_ == "6") {
					mui.openWindow({
						url: "info_3.html",
						id: "info_3",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				} else if(class_ == "7") {
					mui.openWindow({
						url: "info_4.html",
						id: "info_4",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				} else {
					mui.openWindow({
						url: "info_5.html",
						id: "info_5",
						extras: {
							userClass: userClass,
							companyId: companyId,
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId
						}
					});
				}
			});

			function addItem(itemName, class_, badge) {
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var icon = document.createElement("img");
				var content = document.createElement("div");
				var p = document.createElement(p);
				icon.setAttribute("class", "mui-media-object mui-pull-left");
				icon.src = "image/" + class_ + ".png";
				icon.style.width = "24px";
				icon.style.height = "24px";
				li.setAttribute("class", "mui-table-view-cell mui-card-content");
				li.setAttribute("id", class_);
//				li.appendChild(icon);
//				p.style.font = "1em";
				p.innerHTML = itemName;
				content.setAttribute("class", "mui-card-content");
				content.appendChild(icon);
				content.appendChild(p);
				li.appendChild(content);
				if(badge > 0) {
					var span = document.createElement("span");
					span.setAttribute("class", "mui-badge mui-badge-primary");
					span.innerHTML = badge;
					li.appendChild(span);
				}
				ul.appendChild(li);
			}

			window.addEventListener("refresh", function(event) {
				console.log(event.detail.id);
				var li = document.getElementById(event.detail.id);
				console.log(event.detail.safe_num);
				console.log(li.innerHTML);
				if(event.detail.safe_num == undefined || event.detail.safe_num == "0") {
					li.getElementsByTagName("span")[0].innerHTML = "0";
					li.getElementsByTagName("span")[0].style.display = "none";
				} else {
					li.getElementsByTagName("span")[0].innerHTML = event.detail.safe_num;
				}
			});

			//			function addSpecialItem(itemName, class_, badge) {
			//				var item_name = ["组织结构", "岗位职责", "应急预案", "专职人员", "特种人员"];
			//				var ul = document.getElementById("main");
			//				var li = document.createElement("li");
			//				var a = document.createElement("a");
			//				var item_ul = document.createElement("ul");
			//				item_ul.setAttribute("class", "mui-table-view mui-table-view-chevron");
			//				for(var i=0;i<5;i++){
			//					var item_li = document.createElement("li");
			//					item_li.setAttribute("class", "mui-table-view-cell");
			//					var item_a = document.createElement("a");
			//					item_a.setAttribute("class", "mui-navigate-right");
			//					item_a.innerHTML = item_name[i];
			//					item_li.appendChild(item_a);
			//					item_ul.appendChild(item_li);
			//				}
			//				li.setAttribute("class", "mui-table-view-cell mui-collapse");
			//				li.setAttribute("id", class_);
			//				li.innerHTML = item_name;
			//				if(badge != 0){
			//					var span = document.createElement("span");
			//					span.setAttribute("class", "mui-badge mui-badge-primary");
			//					span.innerHTML = badge;
			//					li.appendChild(span);
			//				}
			//				li.appendChild(item_ul);
			//				ul.appendChild(li);
			//			}			
//			document.getElementById("close").addEventListener("tap", function() {
//				plus.webview.currentWebview().close();
//			});

			document.getElementById("close").addEventListener("tap", function() {
				var parent = plus.webview.getWebviewById("tab-webview-subpage-my.html");
				var safe_num = 0;
				for(var i = 1; i < 9; i++) {
					var li = document.getElementById(i.toString());
					if(li == undefined || li.getElementsByTagName("span")[0] == undefined)
						continue;
					var num = li.getElementsByTagName("span")[0].innerHTML;
					console.log("num:" + num);
					safe_num = safe_num + parseInt(num);
				}
				console.log(safe_num);
				mui.fire(parent, "refresh", {
					safe_num: safe_num,
					id: "approve"
				});
				plus.webview.currentWebview().close();
			});
		</script>
	</body>

</html>