<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			p {
				margin-top: 5px;
				margin-left: 30px;
			}
			
			.Number {
				text-decoration: underline;
				color: #007aff;
			}
		</style>
	</head>

	<body>
		<div id="main">

		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/bomb.js"></script>
		<script src="js/bmob-min.js"></script>
		<script>
			var userClass;
			var companyId;
			var userId;
			var subsidiaryId;
			var supervisionCompanyId;
			var baseUrl = "http://123.206.87.22";

			var dayDangerNum;
			var dayBigDangerNum;
			var monthDangerNum;
			var monthBigDangerNum;

			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					backButtonPress++;
					if(backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				var self = plus.webview.currentWebview();
				userClass = self.userClass;
				companyId = self.companyId;
				userId = self.userId;
				subsidiaryId = self.subsidiaryId;
				supervisionCompanyId = self.supervisionCompanyId;
				console.log(userClass);
				if(userClass == "1") {
					var request_url = baseUrl + "/subsidiary/dangeCount?subsidiaryId=" + subsidiaryId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							getDangerNum(extend.todayAdded, extend.todayImportant, extend.monthAdded, extend.monthImportant);
							addProject("测试");
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "3") {
					var request_url = baseUrl + "/supervision/subs?supervisionCompanyId=" + supervisionCompanyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							addSupervision("中建一局");
							var extend = eval(result.extend);
							var projectList = extend.subsidiaryList;
							console.log(projectList.length);
							for(var i = 0; i < projectList.length; i++) {
								var pro_company = projectList[i].subsidiaryName;
								var projectId = projectList[i].subsidiaryId;
								addProject(pro_company);
								//								var request_url = baseUrl + "/subsidiary/dangeCount?subsidiaryId=" + projectId;
								//								console.log(request_url);
								//								var headers = {
								//									'Accept': 'application/json',
								//									'Content-Type': 'application/json;charset=utf-8',
								//								};
								//								mui.ajax(request_url, {
								//									type: "get",
								//									success: function(result) {
								//										var extend = eval(result.extend);
								//										getDangerNum(extend.todayAdded,extend.todayImportant,extend.monthAdded,extend.monthImportant);
								//										addProject(pro_company);
								//									},
								//									error: function() {
								//										plus.nativeUI.toast("请求失败!");
								//									}
								//								});
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "2") {
					//为业主用户
					var request_url = baseUrl + "/company/todayDangers?companyId=" + companyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							getTotalDangerNum(extend.todayAdded, extend.todayImportant, extend.monthAdded, extend.monthImportant);
							addAdmin("中建一局");
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});

					var request_url = baseUrl + "/company/units?companyId=" + companyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							var projectList = extend.subsidiaryList;
							console.log(projectList.length);
							var supervisionList = extend.supervisionCompanyList;

							for(var i = 0; i < projectList.length; i++) {
								var pro_company = projectList[i].subsidiaryName;
								var projectId = projectList[i].subsidiaryId;
								addProject(pro_company);
								//								var request_url = baseUrl + "/subsidiary/dangeCount?subsidiaryId=" + projectId;
								//								console.log(request_url);
								//								var headers = {
								//									'Accept': 'application/json',
								//									'Content-Type': 'application/json;charset=utf-8',
								//								};
								//								mui.ajax(request_url, {
								//									type: "get",
								//									success: function(result) {
								//										var extend = eval(result.extend);
								//										getDangerNum(extend.todayAdded,extend.todayImportant,extend.monthAdded,extend.monthImportant);
								//										addProject(pro_company);
								//									},
								//									error: function() {
								//										plus.nativeUI.toast("请求失败!");
								//									}
								//								});
							}
							for(var i = 0; i < supervisionList.length; i++) {
								var super_company = supervisionList[i].supervisionCompanyName;
								addSupervision(super_company);
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
			});

			mui.init({
				swipeBack: false,
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: false, //默认为false，不监听
					release: false //默认为false，不监听
				}
			});

			mui('#main').on('tap', '.mui-card', function(e) {
				var node = this.childNodes[0].childNodes[0];
				var name = node.id;
				console.log(name);
				mui.openWindow({
					url: "project_content.html",
					id: "project_content",
					extras: {
						project_name: name.replace(/^\s+|\s+$/g, "")
					}
				});
			});

			String.prototype.format = function() {
				var args = arguments;
				return this.replace(/\{(\d+)\}/g, function(s, i) {
					return args[i];
				});
			}

			function getDangerNum(d1, d2, d3, d4) {
				dayDangerNum = d1;
				dayBigDangerNum = d2;
				monthDangerNum = d3;
				monthBigDangerNum = d4;
			}

			function getTotalDangerNum(d1, d2, d3, d4) {
				dayDangerNum = d1;
				dayBigDangerNum = d2;
				monthDangerNum = d3;
				monthBigDangerNum = d4;
			}

			function addTitle(titleName) {
				var title = document.createElement("h3");
				title.innerHTML = titleName;
				var con_main = document.getElementById("main");
				con_main.appendChild(title);
			}

			function addProject(proName, proId) {
				var stringDayDanger = "今日新增安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(dayDangerNum, dayBigDangerNum);
				var stringMonthDanger = "本月累计安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(monthDangerNum, monthBigDangerNum);
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_inner = document.createElement("div");
				li.setAttribute("class", "mui-card");
				con.setAttribute("class", "mui-card-content");
				con_inner.setAttribute("class", "mui-card-content-inner");
				con_inner.setAttribute("id", proId);
				con_inner.innerHTML = "项目:" + "<span class=\"Number\">" + proName + "</span>";
				con_day_danger = document.createElement("p");
				con_month_danger = document.createElement("p");
				con_day_danger.innerHTML = stringDayDanger;
				con_month_danger.innerHTML = stringMonthDanger;
				con_inner.appendChild(con_day_danger);
				con_inner.appendChild(con_month_danger);
				con.appendChild(con_inner);
				li.appendChild(con);
				ul.appendChild(li);
			}

			function addAdmin(companyName) {
				var stringDayDanger = "今日新增安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(dayDangerNum, dayBigDangerNum);
				var stringMonthDanger = "本月累计安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(monthDangerNum, monthBigDangerNum);
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_inner = document.createElement("div");
				li.setAttribute("class", "mui-card");
				con.setAttribute("class", "mui-card-content");
				con_inner.setAttribute("class", "mui-card-content-inner");
				con_inner.setAttribute("id", "project");
				con_inner.innerHTML = "业主:" + "<span class=\"Number\">" + companyName + "</span>";
				con_day_danger = document.createElement("p");
				con_month_danger = document.createElement("p");
				con_day_danger.innerHTML = stringDayDanger;
				con_month_danger.innerHTML = stringMonthDanger;
				con_inner.appendChild(con_day_danger);
				con_inner.appendChild(con_month_danger);
				con.appendChild(con_inner);
				li.appendChild(con);
				ul.appendChild(li);
			}

			function addSupervision(Name) {
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_inner = document.createElement("div");
				li.setAttribute("class", "mui-card");
				con.setAttribute("class", "mui-card-content");
				con_inner.setAttribute("class", "mui-card-content-inner");
				con_inner.setAttribute("id", "supervision");
				con_inner.innerHTML = "监理:" + Name;
				con.appendChild(con_inner);
				li.appendChild(con);
				ul.appendChild(li);
			}
		</script>

	</body>

</html>