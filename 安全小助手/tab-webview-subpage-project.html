<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			p {
				margin-top: 5px;
				margin-left: 30px;
				color: #000;
			}
			
			.Number {
				text-decoration: underline;
				color: #555555;
			}
			
			.mui-card{
				color: #FFFFFF;
			}
			
			#admin{
				background: #6a98c6;
			}
			
			#admin p{
				color: #000
			}
			
			#admin .mui-card-media p{
				font-size: medium;
			}
			
			#admin .mui-card-header{
				padding-bottom: 1px;
			}
			
			#admin .mui-card-content-inner{
				background: #FFF;
			}
			
			#project{
				background: #589dcc;
			}
			
			#project .mui-card-media p{
				font-size: medium;
			}
			
			#project .mui-card-header{
				padding-bottom: 1px;
			}
			
			#project .mui-card-content-inner{
				background: #FFF;
			}
			
			#super{
				background: #5b8dc4;
			}
			
			#super .mui-card-header{
				padding-bottom: 1px;
			}
			
			#super .mui-card-media p{
				font-size: medium;
			}
		</style>
	</head>
	<body>
		<div id="main">
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/bomb.js"></script>
		<script src="js/bmob-min.js"></script>
		<script>
			var pro_info = new Array();
			var userClass;
			var companyId;
			var userId;
			var subsidiaryId;
			var supervisionCompanyId;
			var companyName;
			var subsidiaryName;
			var supervisionCompanyName;
			var baseUrl = "http://123.206.87.22";

			var dayDangerNum;
			var dayBigDangerNum;
			var monthDangerNum;
			var monthBigDangerNum;
			
			var proLen = 0;
			var superLen = 0;

			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					backButtonPress++;
					if(backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				var self = plus.webview.currentWebview();
				userClass = self.userClass;
				companyId = self.companyId;
				userId = self.userId;
				console.log(userId);
				subsidiaryId = self.subsidiaryId;
				supervisionCompanyId = self.supervisionCompanyId;
				companyName = self.companyName;
				subsidiaryName = self.subsidiaryName;
				console.log(subsidiaryName);
				supervisionCompanyName = self.supervisionCompanyName;
				var mark = false;
				if(userClass == "1" || userClass == "101") {
					var request_url = baseUrl + "/subsidiary/dangerCount?subsidiaryId=" + subsidiaryId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							console.log(extend.monthAdded);
							dayDangerNum = extend.todayAdded;
							dayBigDangerNum = extend.todayImportant;
							monthDangerNum = extend.monthAdded;
							monthBigDangerNum = extend.monthImportant;
							addProject(subsidiaryName, subsidiaryId);
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "2" || userClass == "201") {
					var request_url = baseUrl + "/supervision/subs?supervisionCompanyId=" + supervisionCompanyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							addSupervision(supervisionCompanyName, supervisionCompanyId);
							var extend = eval(result.extend);
							var projectList = extend.subsidiaryList;
							proLen = projectList.length;
							console.log(projectList.length);
							for(var i = 0; i < projectList.length; i++) {
								var pro_company = projectList[i].subsidiaryName;
								var projectId = projectList[i].subsidiaryId;
								var request_url = baseUrl + "/subsidiary/dangerCount?subsidiaryId=" + projectId;
								console.log(request_url);
								var headers = {
									'Accept': 'application/json',
									'Content-Type': 'application/json;charset=utf-8',
								};
								mui.ajax(request_url, {
									type: "get",
									success: function(result) {
										var extend = eval(result.extend);
										dayDangerNum = extend.todayAdded;
										dayBigDangerNum = extend.todayImportant;
										monthDangerNum = extend.monthAdded;
										monthBigDangerNum = extend.monthImportant;
										var projectId = extend.subsidiary.subsidiaryId;
										var projectName = extend.subsidiary.subsidiaryName;
										addProject(projectName, projectId);
									},
									error: function() {
										plus.nativeUI.toast("请求失败!");
									}
								});
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "3" || userClass == "301" || userClass == "401") {					
					var request_url = baseUrl + "/company/todayDangers?companyId=" + companyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							console.log(extend.monthAdded + " " + extend.monthImportant)
							dayDangerNum = extend.todayAdded;
							dayBigDangerNum = extend.todayImportant;
							monthDangerNum = extend.monthAdded;
							monthBigDangerNum = extend.monthImportant;
							addAdmin(companyName, companyId);
							mark = true;

							var request_url = baseUrl + "/company/units?companyId=" + companyId;
							console.log(request_url);
							var headers = {
								'Accept': 'application/json',
								'Content-Type': 'application/json;charset=utf-8',
							};
							mui.ajax(request_url, {
								type: "get",
								success: function(result) {
									var extend = eval(result.extend);
									var projectList = extend.subsidiaryList;
									proLen = projectList.length;
									for(var i = 0; i < projectList.length; i++) {
										var pro_company = projectList[i].subsidiaryName;
										var projectId = projectList[i].subsidiaryId;
										pro_info.push([pro_company, projectId]);
										var request_url = baseUrl + "/subsidiary/dangerCount?subsidiaryId=" + projectId;
										var headers = {
											'Accept': 'application/json',
											'Content-Type': 'application/json;charset=utf-8',
										};
										mui.ajax(request_url, {
											type: "get",
											success: function(result) {
												var pro_ = pro_info.shift();
												var extend = eval(result.extend);
												dayDangerNum = extend.todayAdded;
												dayBigDangerNum = extend.todayImportant;
												monthDangerNum = extend.monthAdded;
												monthBigDangerNum = extend.monthImportant;
												var projectId = extend.subsidiary.subsidiaryId;
												var projectName = extend.subsidiary.subsidiaryName;
												addProject(projectName, projectId);
											},
											error: function() {
												plus.nativeUI.toast("请求失败!");
											}
										});
									}
								},
								error: function() {
									plus.nativeUI.toast("请求失败!");
								}
							});
							setTimeout(function() {

								var request_url = baseUrl + "/company/units?companyId=" + companyId;
								var headers = {
									'Accept': 'application/json',
									'Content-Type': 'application/json;charset=utf-8',
								};
								mui.ajax(request_url, {
									type: "get",
									success: function(result) {
										var extend = eval(result.extend);
										var supervisionList = extend.supervisionCompanyList;
										superLen = supervisionList.length;
										for(var i = 0; i < supervisionList.length; i++) {
											var super_company = supervisionList[i].supervisionCompanyName;
											//											console.log(supervisionList[i].supervisionCompanyId);
											addSupervision(super_company, supervisionList[i].supervisionCompanyId);
										}
									},
									error: function() {
										plus.nativeUI.toast("请求失败!");
									}
								});
							}, 1000);
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
			});

			window.addEventListener("refresh_num", function() {
				if(userClass == "1" || userClass == "101") {
					var request_url = baseUrl + "/subsidiary/dangerCount?subsidiaryId=" + subsidiaryId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							console.log(extend.monthAdded);
							dayDangerNum = extend.todayAdded;
							dayBigDangerNum = extend.todayImportant;
							monthDangerNum = extend.monthAdded;
							monthBigDangerNum = extend.monthImportant;
							var parent = document.getElementById(subsidiaryId + "," + "1" + "," + userId + "," + companyId);
							var span_list = parent.getElementsByTagName("span");
							span_list[0].innerHTML = " " + dayDangerNum + " "; 
							span_list[1].innerHTML = " " + dayBigDangerNum + " ";
							span_list[2].innerHTML = " " + monthDangerNum + " ";
							span_list[3].innerHTML = " " + monthBigDangerNum + " ";
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "2" || userClass == "201") {
					var request_url = baseUrl + "/supervision/subs?supervisionCompanyId=" + supervisionCompanyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							//							addSupervision(supervisionCompanyName, supervisionCompanyId);
							var extend = eval(result.extend);
							var projectList = extend.subsidiaryList;
							proLen = projectList.length;
							console.log(projectList.length);
							for(var i = 0; i < projectList.length; i++) {
								var pro_company = projectList[i].subsidiaryName;
								var projectId = projectList[i].subsidiaryId;
								var request_url = baseUrl + "/subsidiary/dangerCount?subsidiaryId=" + projectId;
								console.log(request_url);
								var headers = {
									'Accept': 'application/json',
									'Content-Type': 'application/json;charset=utf-8',
								};
								mui.ajax(request_url, {
									type: "get",
									success: function(result) {
										var extend = eval(result.extend);
										dayDangerNum = extend.todayAdded;
										dayBigDangerNum = extend.todayImportant;
										monthDangerNum = extend.monthAdded;
										monthBigDangerNum = extend.monthImportant;
										var projectId = extend.subsidiary.subsidiaryId;
										var projectName = extend.subsidiary.subsidiaryName;
										var parent = document.getElementById(projectId + "," + "1" + "," + userId + "," + companyId);
										var span_list = parent.getElementsByTagName("span");
										span_list[0].innerHTML = " " + dayDangerNum + " "; 
										span_list[1].innerHTML = " " + dayBigDangerNum + " ";
										span_list[2].innerHTML = " " + monthDangerNum + " ";
										span_list[3].innerHTML = " " + monthBigDangerNum + " ";
									},
									error: function() {
										plus.nativeUI.toast("请求失败!");
									}
								});
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "3" || userClass == "301" || userClass == "401") {
					var request_url = baseUrl + "/company/todayDangers?companyId=" + companyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							dayDangerNum = extend.todayAdded;
							dayBigDangerNum = extend.todayImportant;
							monthDangerNum = extend.monthAdded;
							monthBigDangerNum = extend.monthImportant;
							console.log(monthBigDangerNum + " " + monthDangerNum);
							var parent = document.getElementById(companyId + "," + "2");
							var span_list = parent.getElementsByTagName("span");
							span_list[0].innerHTML = " " + dayDangerNum + " "; 
							span_list[1].innerHTML = " " + dayBigDangerNum + " ";
							span_list[2].innerHTML = " " + monthDangerNum + " ";
							span_list[3].innerHTML = " " + monthBigDangerNum + " ";

							var request_url = baseUrl + "/company/units?companyId=" + companyId;
							var headers = {
								'Accept': 'application/json',
								'Content-Type': 'application/json;charset=utf-8',
							};
							mui.ajax(request_url, {
								type: "get",
								success: function(result) {
									var extend = eval(result.extend);
									var projectList = extend.subsidiaryList;
									proLen = projectList.length;
									var i = 0;
									for(i = 0; i < projectList.length; i++) {
										var pro_company = projectList[i].subsidiaryName;
										var projectId = projectList[i].subsidiaryId;
										pro_info.push([pro_company, projectId]);
										var request_url = baseUrl + "/subsidiary/dangerCount?subsidiaryId=" + projectId;
										var headers = {
											'Accept': 'application/json',
											'Content-Type': 'application/json;charset=utf-8',
										};
										mui.ajax(request_url, {
											type: "get",
											success: function(result) {
												var pro_ = pro_info.shift();
												var extend = eval(result.extend);
												dayDangerNum = extend.todayAdded;
												dayBigDangerNum = extend.todayImportant;
												monthDangerNum = extend.monthAdded;
												monthBigDangerNum = extend.monthImportant;
												var projectId = extend.subsidiary.subsidiaryId;
												var projectName = extend.subsidiary.subsidiaryName;
												var parent = document.getElementById(projectId + "," + "1" + "," + userId + "," + companyId);
												var span_list = parent.getElementsByTagName("span");
												span_list[0].innerHTML = " " + dayDangerNum + " "; 
												span_list[1].innerHTML = " " + dayBigDangerNum + " ";
												span_list[2].innerHTML = " " + monthDangerNum + " ";
												span_list[3].innerHTML = " " + monthBigDangerNum + " ";
											},
											error: function() {
												plus.nativeUI.toast("请求失败!");
											}
										});
									}
								},
								error: function() {
									plus.nativeUI.toast("请求失败!");
								}
							});
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
			});

			mui('#main').on('tap', '.mui-card', function(e) {
				var node = this.childNodes[0].childNodes[1];
				if(node == undefined)
					var name = this.childNodes[0].childNodes[0].id;
				else{
					var name = node.id;
				}
				var tmp = name.split(",");
				console.log(tmp[0]);
				if(tmp[1] == "2") {
					mui.openWindow({
						url: "project_content_.html",
						id: "project_content_",
						extras: {
							from: 2,
							id_: tmp[0],
							class_: tmp[1],
							subsidiaryId: subsidiaryId,
							userId: userId,
							supervisionCompanyId: supervisionCompanyId,
							companyId: companyId,
							userClass: userClass
						}
					});
				} else if(tmp[1] == "3") {
					mui.openWindow({
						url: "project_content_.html",
						id: "project_content_",
						extras: {
							from: 3,
							id_: tmp[0],
							class_: tmp[1],
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: tmp[0],
							companyId: companyId,
							userClass: userClass
						}
					});
				} else {
					mui.openWindow({
						url: "project_content.html",
						id: "project_content",
						extras: {
							from: 1,
							id_: tmp[0],
							class_: tmp[1],
							userId: userId,
							subsidiaryId: subsidiaryId,
							supervisionCompanyId: supervisionCompanyId,
							companyId: companyId,
							userClass: userClass
						}
					});
				}
			});

			String.prototype.format = function() {
				var args = arguments;
				return this.replace(/\{(\d+)\}/g, function(s, i) {
					return args[i];
				});
			}

			function assign(a, b, c, d) {
				dayDangerNum = a;
				dayBigDangerNum = b;
				monthDangerNum = c;
				monthBigDangerNum = d;
			}

			function addProject(proName, proId) {
				var stringDayDanger = "今日新增安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(dayDangerNum, dayBigDangerNum);
				var stringMonthDanger = "本月累计安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(monthDangerNum, monthBigDangerNum);
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_title = document.createElement("div");
				var img = document.createElement("img");
				var p = document.createElement("p");				
				var con_inner = document.createElement("div");
				li.setAttribute("class", "mui-card");
				li.setAttribute("id", "project");
				con.setAttribute("class", "mui-card-content");
				con_title.setAttribute("class", "mui-card-header mui-card-media");
				img.src = "image/project.png";
				img.setAttribute("class", "mui-media-icon");
				con_title.appendChild(img);
				p.innerHTML = proName;
//				con_title.innerHTML = "项目部:" + "<span class=\"Number\">" + proName + "</span>";
				con_title.appendChild(p);
				con_inner.setAttribute("class", "mui-card-content-inner");
				con_inner.setAttribute("id", proId + "," + "1" + "," + userId + "," + companyId);
//				con_inner.innerHTML = "项目部:" + "<span class=\"Number\">" + proName + "</span>";
				con_day_danger = document.createElement("p");
				con_month_danger = document.createElement("p");
				con_day_danger.innerHTML = stringDayDanger;
				con_month_danger.innerHTML = stringMonthDanger;
				con_inner.appendChild(con_day_danger);
				con_inner.appendChild(con_month_danger);
				con.appendChild(con_title);
				con.appendChild(con_inner);
				li.appendChild(con);
				ul.appendChild(li);
			}

			function addAdmin(companyName, companyId) {
				console.log(monthDangerNum + " " + monthBigDangerNum);
				var stringDayDanger = "今日新增安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(dayDangerNum, dayBigDangerNum);
				var stringMonthDanger = "本月累计安全隐患<span class=\"Number\"> {0} </span>起，重大隐患<span class=\"Number\"> {1} </span>起".format(monthDangerNum, monthBigDangerNum);
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_title = document.createElement("div");
				var img = document.createElement("img");
				var p = document.createElement("p");
				var con_inner = document.createElement("div");
				li.setAttribute("class", "mui-card");
				li.setAttribute("id", "admin");
				con.setAttribute("class", "mui-card-content");
				con_title.setAttribute("class", "mui-card-header mui-card-media");
				img.src = "image/admin.png";
				img.setAttribute("class", "mui-media-icon");
				con_title.appendChild(img);
				p.innerHTML = companyName;
//				div.setAttribute("class", "mui-media-body");
//				div.innerHTML = companyName;
				con_title.appendChild(p);
				con_inner.setAttribute("class", "mui-card-content-inner");
				con_inner.setAttribute("id", companyId + "," + "2");
//				con_inner.innerHTML = "业主:" + "<span class=\"Number\">" + companyName + "</span>";
				con_day_danger = document.createElement("p");
				con_month_danger = document.createElement("p");
				con_day_danger.innerHTML = stringDayDanger;
				con_month_danger.innerHTML = stringMonthDanger;
				con_inner.appendChild(con_day_danger);
				con_inner.appendChild(con_month_danger);
				con.appendChild(con_title);
				con.appendChild(con_inner);
				li.appendChild(con);
				ul.appendChild(li);
			}

			function addSupervision(superName, superId) {
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_inner = document.createElement("div");
				li.setAttribute("class", "mui-card");
				li.setAttribute("id", "super");
				con.setAttribute("class", "mui-card-content");
				con_inner.setAttribute("class", "mui-card-header mui-card-media");
				var img = document.createElement("img");
				img.src = "image/super.png";
				var p = document.createElement("p");
				con_inner.appendChild(img);
				con_inner.setAttribute("id", superId + "," + "3");
//				con_inner.innerHTML = "监理:" + " " + superName;
				p.innerHTML = superName;
				con_inner.appendChild(p);
				con.appendChild(con_inner);
				li.appendChild(con);
				ul.appendChild(li);
			}
			
			window.addEventListener("refresh_", function(){
				console.log(proLen);
				console.log(superLen);
				if(userClass == undefined)
					return;
				if(userClass == "301" || userClass == "3" || userClass == "401" || userClass == "4"){
					var request_url = baseUrl + "/company/unitsCount?companyId=" + companyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							console.log(extend.supervisionCompanyCount);
							console.log(extend.subsidiaryCount);
							if(extend.supervisionCompanyCount != superLen || proLen != extend.subsidiaryCount){
								location.reload();
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});					
				}else if(userClass == "201" || userClass == "2"){
					var request_url = baseUrl + "/supervision/subsCount?supervisionCompanyId=" + supervisionCompanyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							if(proLen != extend.subsidiaryCount){
								location.reload();
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});						
				}else{
					
				}
			});
		</script>

	</body>

</html>