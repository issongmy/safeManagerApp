<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<style>
			.mui-bar {
				background: #fff;
			}
			
			#span_left {
				float: left
			}
			
			#span_right {
				float: right
			}
		</style>
	</head>

	<body>
		<header id="title" class="mui-bar mui-bar-nav">
			<a id="close" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">三级教育审批</h1>
		</header>
		<div id="main" id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<ul id="eduList" class="mui-table-view mui-table-view-chevron">
				</ul>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript">
			var baseUrl = "http://123.206.87.22";
			var companyId;
			mui.init();
			mui.plusReady(function() {
				if(mui.os.ios)
					document.getElementById("title").style.marginTop = "40px";					
				mui.oldBack = mui.back;
				mui.back = function() {
					var w = plus.webview.getWebviewById("tab-webview-subpage-project.html");
					var self = plus.webview.currentWebview();
					self.parent().evalJS('mui.back();');
					self.close();
					old_back();
				};
				var self = plus.webview.currentWebview();
				var from = self.from;
				var userClass = self.userClass;
				companyId = self.companyId;
				var subsidiaryId = self.subsidiaryId;
				console.subsidiaryId;
				var supervisionCompanyId = self.supervisionCompanyId;
				var request_url = baseUrl + "/subsidiary/safetyEdu?subsidiaryId=" + subsidiaryId;
				console.log(request_url);
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						var eduList = extend.pageInfo.list;
						for(var i = 0; i < eduList.length; i++) {
							var safetyEduId = eduList[i].safetyEdu;
							var uploadTime = eduList[i].uploadTime;
							var currentState = eduList[i].currentState;
							var safetyEduHtml = eduList[i].safetyEduHtml;
							addEdu(safetyEduId, uploadTime, currentState, safetyEduHtml);
						}
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});

			});

			document.getElementById("main").addEventListener("swiperight", function() {
				var self = plus.webview.currentWebview();
				self.parent().evalJS('mui.back();');
				self.close();
			});

			mui('.mui-table-view').on('tap', '.mui-table-view-cell', function(e) {
				var node = this.childNodes;
				var safetyEduId = node[0].value;
				var uploadTime = node[1].value;
				var currentState = node[2].value;
				var safetyEduHtml = node[3].value;
				console.log("http://dcsapi.com/?k=187082898&url=http://smyz.me/resource/safetyEdu/" + safetyEduHtml);
				//				mui.openWindow({
				//					url: "http://dcsapi.com/?k=187082898&url=http://smyz.me/resource/safetyEdu/" + safetyEduHtml,
				//					id: safetyEduHtml,
				//					styles: { // 窗口参数 参考5+规范中的WebviewStyle,也就是说WebviewStyle下的参数都可以在此设置
				//						titleNView: { // 窗口的标题栏控件
				//							titleText: "三级教育", // 标题栏文字,当不设置此属性时，默认加载当前页面的标题，并自动更新页面的标题
				//							titleColor: "#000000", // 字体颜色,颜色值格式为"#RRGGBB",默认值为"#000000"
				//							titleSize: "17px", // 字体大小,默认17px
				//							backgroundColor: "#F7F7F7", // 控件背景颜色,颜色值格式为"#RRGGBB",默认值为"#F7F7F7"
				//							progress: { // 标题栏控件的进度条样式
				//								color: "#00FF00", // 进度条颜色,默认值为"#00FF00"  
				//								height: "2px" // 进度条高度,默认值为"2px"         
				//							},
				//							splitLine: { // 标题栏控件的底部分割线，类似borderBottom
				//								color: "#CCCCCC", // 分割线颜色,默认值为"#CCCCCC"  
				//								height: "1px" // 分割线高度,默认值为"2px"
				//							},
				//							autoBackButton: true
				//						}
				//					}
				//				});
				mui.openWindow({
					url: "three_edu_approve_table.html",
					id: "three_edu_approve_table",
					extras: {
						companyId: companyId,
						safetyEduId: safetyEduId,
						uploadTime: uploadTime,
						currentState: currentState,
						safetyEduHtml: safetyEduHtml
					}
				});
			});

			function addEdu(safetyEduId, uploadTime, currentState, safetyEduHtml) {
				var main = document.getElementById("main");
				var ul = document.getElementById("eduList");
				var liObj = document.createElement("li");
				var a = document.createElement("p");
				var span_num = document.createElement("span");
				span_num.setAttribute("id", "span_left");
				span_num.innerHTML = safetyEduId;
				var span_other = document.createElement("span");
				span_other.setAttribute("id", "span_right");
				span_other.innerHTML = convUnixTimestamp(uploadTime);
				liObj.setAttribute("class", "mui-table-view-cell");
				a.setAttribute("class", "mui-navigate-right");
				a.setAttribute("id", safetyEduId);
				a.appendChild(span_num);
				a.appendChild(span_other);
				var hidden_input = document.createElement("input");
				hidden_input.setAttribute("type", "hidden");
				hidden_input.setAttribute("id", "safetyEduId");
				hidden_input.setAttribute("value", safetyEduId);
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "uploadTime";
				hidden_input.value = uploadTime;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "currentState";
				hidden_input.value = currentState;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "safetyEduHtml";
				hidden_input.value = safetyEduHtml;
				liObj.appendChild(hidden_input);
				liObj.appendChild(a);
				ul.appendChild(liObj);
			}

			document.getElementById("close").addEventListener("tap", function() {
				var w = plus.webview.getWebviewById("tab-webview-subpage-project.html");
				var self = plus.webview.currentWebview();
				self.parent().evalJS('mui.back();');
				self.close();
			});

			function convUnixTimestamp(timeStamp) {
				var date = new Date(parseInt(timeStamp));
				var Y = date.getFullYear() + '-';
				var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
				var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' ';
				var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
				var m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
				var s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds());
				return Y + M + D + h + m + s;
			}
		</script>
	</body>

</html>