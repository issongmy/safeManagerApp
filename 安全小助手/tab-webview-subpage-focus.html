<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style>

		</style>
	</head>

	<body>
		<div id="main" class="mui-content mui-scroll-wrapper">
		</div>
		<script src="js/bmob-min.js"></script>
		<script src="js/bmob.js"></script>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript">
			var userClass;
			var companyId;
			var userId;
			var subsidiaryId;
			var supervisionCompanyId;
			var baseUrl = "http://123.206.87.22";
			
			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: false, //默认为false，不监听
					release: false //默认为false，不监听
				}
			});
			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					backButtonPress++;
					if(backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				var self = plus.webview.currentWebview();
				userClass = self.userClass;
				companyId = self.companyId;
				userId = self.userId;
				subsidiaryId = self.subsidiaryId;
				supervisionCompanyId = self.supervisionCompanyId;
				if(userClass == "1"){
					var request_url = baseUrl + "/subsidiary/focus?subsidiaryId=" + subsidiaryId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							console.log(result.length);
							var extend = eval(result.extend);
							var dangerList = extend.list;
							for(var i = 0; i < dangerList.length; i++) {
								var dangerId = dangerList[i].dangerId;
								var level = dangerList[i].severity;
								var state = dangerList[i].currentState;
								if(state == "1") {
									if(level) {
										addDanger(dangerId, "重大隐患", "提交审核中");
									} else {
										addDanger(dangerId, "一般隐患", "提交审核中");
									}
								} else if(state == "2") {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改中");
									} else {
										addDanger(dangerId, "一般隐患", "整改中");
									}
								} else if(state == "3") {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改审核中");
									} else {
										addDanger(dangerId, "一般隐患", "整改审核中");
									}
								} else {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改完毕");
									} else {
										addDanger(dangerId, "一般隐患", "整改完毕");
									}
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "2"){
					var request_url = baseUrl + "/company/focus?companyId=" + companyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					console.log(request_url);
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							console.log(result.length);
							var extend = eval(result.extend);
							var dangerList = extend.list;
							for(var i = 0; i < dangerList.length; i++) {
								var dangerId = dangerList[i].dangerId;
								var level = dangerList[i].severity;
								var state = dangerList[i].currentState;
								if(state == "1") {
									if(level) {
										addDanger(dangerId, "重大隐患", "提交审核中");
									} else {
										addDanger(dangerId, "一般隐患", "提交审核中");
									}
								} else if(state == "2") {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改中");
									} else {
										addDanger(dangerId, "一般隐患", "整改中");
									}
								} else if(state == "3") {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改审核中");
									} else {
										addDanger(dangerId, "一般隐患", "整改审核中");
									}
								} else {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改完毕");
									} else {
										addDanger(dangerId, "一般隐患", "整改完毕");
									}
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "3"){
					var request_url = baseUrl + "/supervision/focus?supervisionCompanyId=" + supervisionCompanyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							console.log(result.length);
							var extend = eval(result.extend);
							var dangerList = extend.list;
							for(var i = 0; i < dangerList.length; i++) {
								var dangerId = dangerList[i].dangerId;
								var level = dangerList[i].severity;
								var state = dangerList[i].currentState;
								if(state == "1") {
									if(level) {
										addDanger(dangerId, "重大隐患", "提交审核中");
									} else {
										addDanger(dangerId, "一般隐患", "提交审核中");
									}
								} else if(state == "2") {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改中");
									} else {
										addDanger(dangerId, "一般隐患", "整改中");
									}
								} else if(state == "3") {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改审核中");
									} else {
										addDanger(dangerId, "一般隐患", "整改审核中");
									}
								} else {
									if(level) {
										addDanger(dangerId, "重大隐患", "整改完毕");
									} else {
										addDanger(dangerId, "一般隐患", "整改完毕");
									}
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
			});

			window.addEventListener('refresh', function(event) {
				location.reload();
			});

			String.prototype.format = function() {
				var args = arguments;
				return this.replace(/\{(\d+)\}/g, function(s, i) {
					return args[i];
				});
			}
			
			mui("#main").on("tap", ".mui-card", function(){
				mui.openWindow({
					url: "safe_handle_table.html",
					id: "safe_handle_table",
					extras: {
					}
				});
			});
			
			function addDanger(proName) {
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_inner = document.createElement("div");
				li.setAttribute("class", "mui-card");
				con.setAttribute("class", "mui-card-content");
				con_inner.setAttribute("class", "mui-card-content-inner");
				con_inner.setAttribute("id", "hidden_danger_data");
				var p_pro = document.createElement("p");
				var p_rea = document.createElement("p");
				var p_sit = document.createElement("p");
				p_pro.innerHTML = "责任单位:";
				p_rea.innerHTML = "关注原因:";
				p_sit.innerHTML = "隐患概况:";
				var span_sit = document.createElement("span");
				span_sit.setAttribute("id", "span_right");
				span_sit.innerHTML = "(点击打开重大隐患处置表)";
				var span_rea = document.createEl
				var span_pro = document.createElement("span");
				span_pro.setAttribute("id", "span_right");
				span_pro.innerHTML = proName;
				var span_rea = document.createElement("span");
				span_rea.setAttribute("id", "span_right");
				str_danger = "重大隐患";
				str_overdate = "逾期未整改";
				span_rea.innerHTML = str_danger;
				p_rea.appendChild(span_rea);
				p_pro.appendChild(span_pro);
				p_sit.appendChild(span_sit);
				con_inner.appendChild(p_pro);
				con_inner.appendChild(p_rea);
				con_inner.appendChild(p_sit);
				con.appendChild(con_inner);
				li.appendChild(con);
				ul.appendChild(li);
			}
		</script>
	</body>

</html>