<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style>
		</style>
	</head>

	<body>
		<div id="main" class="mui-content">
		</div>
		<script src="js/bmob-min.js"></script>
		<script src="js/bmob.js"></script>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript">
			var userClass;
			var companyId;
			var userId;
			var userName;
			var subsidiaryId;
			var supervisionCompanyId;
			var baseUrl = "http://106.14.122.40";
			var length;

			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: false, //默认为false，不监听
					release: false //默认为false，不监听
				}
			});

			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					backButtonPress++;
					if(backButtonPress > 1) {
						plus.runtime.quit();
					} else {
						plus.nativeUI.toast('再按一次退出应用');
					}
					setTimeout(function() {
						backButtonPress = 0;
					}, 1000);
					return false;
				};
				var self = plus.webview.currentWebview();
				userName = self.userName;
				userClass = self.userClass;
				console.log(userClass);
				companyId = self.companyId;
				userId = self.userId;
				subsidiaryId = self.subsidiaryId;
				console.log(subsidiaryId);
				supervisionCompanyId = self.supervisionCompanyId;
				if(userClass == "1" || userClass == "101") {
					var request_url = baseUrl + "/subsidiary/focus?subsidiaryId=" + subsidiaryId;
					console.log(subsidiaryId);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							console.log(result.length);
							var extend = eval(result.extend);
							var focusList = extend.list;
							length = focusList.length;
							for(var i = 0; i < focusList.length; i++) {
								var dangerId = focusList[i].dangerId;
								var projectName = focusList[i].subsidiary.subsidiaryName;
								var reason = focusList[i].reason;
								var danger = focusList[i].danger;
								var level = danger.severity;
								var state = danger.currentState;
								var position = danger.dangerPosition;
								var description = danger.dangerDescription;
								var rectificationMeasures = danger.rectificationMeasures;
								var suggestion = danger.suggestion;
								var rectificationPeriod = danger.rectificationPeriod;
								var dangerNumber = danger.dangerNumber;
								var checkTime = danger.checkTime;
								var checkUserId = danger.checkUserId;
								var responsibilityUser = danger.responsibleUserId;
								var dangerImgPath = danger.dangerImgPath;
								if(reason == "1") {
									if(state == "1") {
										addDanger(dangerId, projectName, "重大隐患", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "重大隐患", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "重大隐患", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "重大隐患", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}

								} else if(reason == "2"){
									if(state == "1") {
										addDanger(dangerId, projectName, "逾期未整改", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "逾期未整改", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "逾期未整改", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "逾期未整改", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}
								} else{
									if(state == "1") {
										addDanger(dangerId, projectName, "重大逾期未整改", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}									
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "3" || userClass == "301" || userClass == "401") {
					var request_url = baseUrl + "/company/focus?companyId=" + companyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							var focusList = extend.list;
							length = focusList.length;
							for(var i = 0; i < focusList.length; i++) {
								var dangerId = focusList[i].dangerId;
								var projectName = focusList[i].subsidiary.subsidiaryName;
								var reason = focusList[i].reason;
								var danger = focusList[i].danger;
								var level = danger.severity;
								var state = danger.currentState;
								var position = danger.dangerPosition;
								var description = danger.dangerDescription;
								var rectificationMeasures = danger.rectificationMeasures;
								var suggestion = danger.suggestion;
								var rectificationPeriod = danger.rectificationPeriod;
								var dangerNumber = danger.dangerNumber;
								var checkTime = danger.checkTime;
								var checkUserId = danger.checkUserId;
								var responsibilityUser = danger.responsibleUserId;
								var dangerImgPath = danger.dangerImgPath;
								if(reason == "1") {
									if(state == "1") {
										addDanger(dangerId, projectName, "重大隐患", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "重大隐患", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "重大隐患", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "重大隐患", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}

								} else if(reason == "2"){
									if(state == "1") {
										addDanger(dangerId, projectName, "逾期未整改", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "逾期未整改", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "逾期未整改", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "逾期未整改", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}
								} else{
									if(state == "1") {
										addDanger(dangerId, projectName, "重大逾期未整改", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}									
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
				if(userClass == "2" || userClass == "201") {
					var request_url = baseUrl + "/supervision/focus?supervisionCompanyId=" + supervisionCompanyId;
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							console.log(result.length);
							var extend = eval(result.extend);
							var focusList = extend.list;
							length = focusList.length;
							for(var i = 0; i < focusList.length; i++) {
								var dangerId = focusList[i].dangerId;
								var projectName = focusList[i].subsidiary.subsidiaryName;
								var reason = focusList[i].reason;
								var danger = focusList[i].danger;
								var level = danger.severity;
								var state = danger.currentState;
								var position = danger.dangerPosition;
								var description = danger.dangerDescription;
								var rectificationMeasures = danger.rectificationMeasures;
								var suggestion = danger.suggestion;
								var rectificationPeriod = danger.rectificationPeriod;
								var dangerNumber = danger.dangerNumber;
								var checkTime = danger.checkTime;
								var checkUserId = danger.checkUserId;
								var responsibilityUser = danger.responsibleUserId;
								var dangerImgPath = danger.dangerImgPath;
								if(reason == "1") {
									if(state == "1") {
										addDanger(dangerId, projectName, "重大隐患", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "重大隐患", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "重大隐患", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "重大隐患", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}

								} else if(reason == "2"){
									if(state == "1") {
										addDanger(dangerId, projectName, "逾期未整改", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "逾期未整改", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "逾期未整改", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "逾期未整改", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}
								} else{
									if(state == "1") {
										addDanger(dangerId, projectName, "重大逾期未整改", "提交审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else if(state == "2") {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);

									} else if(state == "3") {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改审核中", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									} else {
										addDanger(dangerId, projectName, "重大逾期未整改", "整改完毕", dangerNumber,
											checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position);
									}									
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
			});

			String.prototype.format = function() {
				var args = arguments;
				return this.replace(/\{(\d+)\}/g, function(s, i) {
					return args[i];
				});
			}

			mui("#main").on("tap", ".mui-card", function() {
				var node = this.childNodes;
				var dangerNumber = node[0].value;
				var checkTime = node[1].value;
				var checkUserId = node[2].value;
				var state = node[3].value;
				var level = node[4].value;
				var description = node[5].value;
				var suggestion = node[6].value;
				var rectificationMeasures = node[7].value;
				var rectificationPeriod = node[8].value;
				var responsibilityUser = node[9].value;
				var dangerImgPath = node[10].value;
				var dangerId = node[11].value;
				var position = node[12].value;
				mui.openWindow({
					url: "safe_handle_table_.html",
					id: "safe_handle_table_",
					extras: {
						from: "1",
						userName: userName,
						dangerNumber: dangerNumber,
						checkTime: checkTime,
						checkUser: checkUserId,
						state: state,
						level: level,
						description: description,
						suggestion: suggestion,
						rectificationMeasures: rectificationMeasures,
						rectificationPeriod: rectificationPeriod,
						responsibilityUser: responsibilityUser,
						dangerImgPath: dangerImgPath,
						dangerId: dangerId,
						dangerPos: position
					}
				});
			});

			function addDanger(dangerId, proName, reason, state, dangerNumber,
				checkTime, checkUserId, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath, suggestion, position) {
				var ul = document.getElementById("main");
				var li = document.createElement("div");
				var con = document.createElement("div");
				var con_inner = document.createElement("div");
				var con_footer = document.createElement("div");
				var con_img = document.createElement("div");
				con_img.setAttribute("class", "mui-card-header mui-card-media");
				if(dangerImgPath == null || dangerImgPath == "")
					var img_url = "image/zw.jpg";
				else {
					var img_url = baseUrl + "/resource/pressDangerImg/" + dangerImgPath;
				}				
//				var img_url = baseUrl + "/resource/pressDangerImg/" + dangerImgPath;
				con_img.style.backgroundImage = "url(" + img_url + ")";
				con_img.style.height = "40vw";
				con_footer.setAttribute("class", "mui-card-footer");
				li.setAttribute("class", "mui-card");
				con.setAttribute("class", "mui-card-content");
				con_inner.setAttribute("class", "mui-card-content-inner");
				con_inner.setAttribute("id", dangerId);
				var a_pro = document.createElement("a");
				var a_rea = document.createElement("a");
				var p_sit = document.createElement("p");
				var p_pos = document.createElement("p");
				p_pos.style.color = "#000";
				a_pro.innerHTML = proName;
				a_pro.setAttribute("class", "mui-card-link");
				a_rea.setAttribute("class", "mui-card-link");
				if(reason == "重大隐患"){
					a_rea.innerHTML = reason;
					a_rea.style.color = "red";
				} else if(reason == "逾期未整改"){
					a_rea.innerHTML = reason;
					a_rea.style.color = "green";
				} else { 
					a_rea.innerHTML = "<span style=\"color: red\">重大</span><span style=\"color: green\">逾期未整改</span>";
				}
				p_sit.innerHTML = convUnixTimestamp(checkTime);
				p_pos.innerHTML = position;
				con_footer.appendChild(a_pro);
				con_footer.appendChild(a_rea);
				con_inner.appendChild(p_sit);
				con_inner.appendChild(p_pos);
				con.appendChild(con_img);
				con.appendChild(con_inner);
				con.appendChild(con_footer);
				var hidden_input = document.createElement("input");
				hidden_input.setAttribute("type", "hidden");
				hidden_input.setAttribute("id", "dangerNumber");
				hidden_input.setAttribute("value", dangerNumber);
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "checkTime";
				hidden_input.value = checkTime;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "checkUserId";
				hidden_input.value = checkUserId;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "state";
				hidden_input.value = state;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "level";
				hidden_input.value = reason;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "description";
				hidden_input.value = description;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "description";
				hidden_input.value = description;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "suggestion";
				hidden_input.value = suggestion;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "rectificationPeriod";
				hidden_input.value = rectificationPeriod;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "responsibilityUser";
				hidden_input.value = responsibilityUser;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "dangerImgPath";
				hidden_input.value = dangerImgPath;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "dangerId";
				hidden_input.value = dangerId;
				li.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "position";
				hidden_input.value = position;
				li.appendChild(hidden_input);				
				li.appendChild(con);
				ul.appendChild(li);
			}
				
			function convUnixTimestamp(timeStamp) {
				var date = new Date(parseInt(timeStamp));
				var Y = date.getFullYear() + '-';
				var M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
				var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' ';
				var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
				var m = (date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
				var s = (date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds());
				return Y + M + D + h + m + s;
			}				

			window.addEventListener("refresh_", function() {
				console.log(length);
				console.log(userClass);
				if(userClass == undefined)
					return;
				if(userClass == "301" || userClass == "3" || userClass == "401" || userClass == "4") {
					var request_url = baseUrl + "/company/focusCount?companyId=" + companyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							if(extend.focusCount != length) {
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_2", {
									state: "1"
								});								
								location.reload();
							}else{
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_2", {
									state: "0"
								});								
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				} else if(userClass == "201" || userClass == "2") {
					var request_url = baseUrl + "/supervision/focusCount?supervisionCompanyId=" + supervisionCompanyId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							if(extend.focusCount != length) {
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_2", {
									state: "1"
								});								
								location.reload();
							}else{
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_2", {
									state: "0"
								});								
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				} else {

				}
				if(userClass == "101" || userClass == "1") {
					console.log(userClass);
					var request_url = baseUrl + "/subsidiary/focusCount?subsidiaryId=" + subsidiaryId;
					console.log(request_url);
					var headers = {
						'Accept': 'application/json',
						'Content-Type': 'application/json;charset=utf-8',
					};
					mui.ajax(request_url, {
						type: "get",
						success: function(result) {
							var extend = eval(result.extend);
							if(extend.focusCount != length) {
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_2", {
									state: "1"
								});								
								location.reload();
							}else{
								var parent = plus.webview.getWebviewById("main");
								mui.fire(parent, "update_2", {
									state: "0"
								});								
							}
						},
						error: function() {
							plus.nativeUI.toast("请求失败!");
						}
					});
				}
			});
		</script>
	</body>

</html>