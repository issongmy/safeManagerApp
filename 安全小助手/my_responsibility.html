<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style type="text/css">
			.mui-bar {
				background: #fff;
			}
			
			#span_left {
				float: left
			}
			
			#span_right {
				float: right
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a id="close" class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">我的责任</h1>
		</header>
		<div id="main" id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-segmented-control">
				<a class="mui-control-item">隐患名</a>
				<a class="mui-control-item mui-active">隐患等级</a>
				<a class="mui-control-item">审核状态</a>
			</div>			
			<div class="mui-scroll">
				<ul id="activity" class="mui-table-view mui-table-view-chevron">
				</ul>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/mui.picker.js"></script>
		<script src="js/mui.poppicker.js"></script>
		<script src="js/bmob-min.js">
			//Bmob.initialize("a1f13b7b63583b190ed6892a0488a02b","38b375d47da756112ccc020e72075385")
		</script>
		<script src="js/bomb.js"></script>
		<script type="text/javascript">
			var baseUrl = "http://123.206.87.22";
			var format = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
			mui.init();
			mui.plusReady(function() {
				mui.oldBack = mui.back;
				var backButtonPress = 0;
				mui.back = function(event) {
					plus.webview.currentWebview().close();
				};
				var self = plus.webview.currentWebview();
				var userClass = self.userClass;
				var companyId = self.companyId;
				var userId = self.userId;
				var subsidiaryId = self.subsidiaryId;
				var supervisionCompanyId = self.supervisionCompanyId;
				var request_url = baseUrl + "/user/responsibilityDangers?userId=" + userId;
				console.log(request_url);
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						var dangerList = extend.list;
						for(var i = 0; i < dangerList.length; i++) {
							var dangerId = dangerList[i].dangerId;
							var position = dangerList[i].dangerPosition;
							var level = dangerList[i].severity;
							var state = dangerList[i].currentState;
							var description = dangerList[i].dangerDescription;
							var rectificationMeasures = dangerList[i].rectificationMeasures;
							var rectificationPeriod = dangerList[i].rectificationPeriod;
							var dangerNumber = dangerList[i].dangerNumber;
							var checkTime = dangerList[i].checkTime;
							var checkUser = dangerList[i].checkUser;
							var responsibilityUser = dangerList[i].responsibleUserId;
							var dangerImgPath = dangerList[i].dangerImgPath;
							if(state == "1") {
								if(level) {
									addDanger(dangerId, position, "重大隐患", "提交审核中", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								} else {
									addDanger(dangerId, position, "一般隐患", "提交审核中", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								}
							} else if(state == "2") {
								if(level) {
									addDanger(dangerId, position, "重大隐患", "整改中", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								} else {
									addDanger(dangerId, position, "一般隐患", "整改中", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								}
							} else if(state == "3") {
								if(level) {
									addDanger(dangerId, position, "重大隐患", "整改审核中", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								} else {
									addDanger(dangerId, position, "一般隐患", "整改审核中", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								}
							} else {
								if(level) {
									addDanger(dangerId, position, "重大隐患", "整改完毕", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								} else {
									addDanger(dangerId, position, "一般隐患", "整改完毕", dangerNumber,
										checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath);
								}
							}
						}
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			});

			mui('.mui-table-view').on('tap', '.mui-table-view-cell', function(e) {
				var node = this.childNodes;
				var dangerNumber = node[0].value;
				var checkTime = node[1].value;
				var checkUser = node[2].value;
				var state = node[3].value;
				var level = node[4].value;
				var description = node[5].value;
				var rectificationMeasures = node[6].value;
				var rectificationPeriod = node[7].value;
				var responsibilityUser = node[8].value;
				var dangerImgPath = node[9].value;
				mui.openWindow({
					url: "safe_handle_table_.html",
					id: "safe_handle_table_",
					extras: {
						dangerNumber: dangerNumber,
						checkTime: checkTime, 
						checkUser: checkUser,
						state: state, 
						level: level,
						description: description,
						rectificationMeasures: rectificationMeasures,
						rectificationPeriod: rectificationPeriod, 
						responsibilityUser: responsibilityUser,
						dangerImgPath: dangerImgPath
					}
				});
			});

			function addDanger(dangerNum, dangerPos, level, state, dangerNumber,
				checkTime, checkUser, description, rectificationMeasures, rectificationPeriod, responsibilityUser, dangerImgPath) {
				var main = document.getElementById("main");					
				var ul = document.getElementById("activity");
				var liObj = document.createElement("li");
				var a = document.createElement("p");
				var span_num = document.createElement("span");
				span_num.setAttribute("id", "span_left");
				span_num.innerHTML = dangerNum + format + level + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + state;
				liObj.setAttribute("class", "mui-table-view-cell");
				a.setAttribute("class", "mui-navigate-right");
				a.setAttribute("id", dangerNum);
				a.appendChild(span_num);
				var hidden_input = document.createElement("input");
				hidden_input.setAttribute("type", "hidden");
				hidden_input.setAttribute("id", "dangerNumber");
				hidden_input.setAttribute("value", dangerNumber);
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "checkTime";
				hidden_input.value = checkTime;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "checkUser";
				hidden_input.value = checkUser;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "state";
				hidden_input.value = state;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "level";
				hidden_input.value = level;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "description";
				hidden_input.value = description;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "rectificationMeasures";
				hidden_input.value = rectificationMeasures;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "rectificationPeriod";
				hidden_input.value = rectificationPeriod;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "responsibilityUser";
				hidden_input.value = responsibilityUser;
				liObj.appendChild(hidden_input);
				var hidden_input = document.createElement("input");
				hidden_input.type = "hidden";
				hidden_input.id = "dangerImgPath";
				hidden_input.value = dangerImgPath;
				liObj.appendChild(hidden_input);				
				liObj.appendChild(a);
				ul.appendChild(liObj);
			}
				
		document.getElementById("close").addEventListener("tap", function() {
			plus.webview.currentWebview().close();
		});	
		</script>
	</body>

</html>