<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.title {
				margin: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
			}
		</style>
	</head>

	<body>
		<!--<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">设置</h1>
		</header>-->
		
		<div id="main" class="mui-content mui-scroll-wrapper">
			<ul class="mui-table-view">
				<li id="myapprove" class="mui-table-view-cell">
					<a class="mui-navigate-right">
						<img src="image/process.png" width="18px" />
						<span>新的审批</span>
						<span id="approve" class="mui-badge mui-badge-primary"></span>
					</a>
				</li>
				<li id="myres" class="mui-table-view-cell">
					<a class="mui-navigate-right">
						<img src="image/pin.png" width="18px" />
						<span>我的责任</span>
						<span id="res" class="mui-badge mui-badge-primary"></span>
					</a>
				</li>
				<li id="mysub" class="mui-table-view-cell">
					<a class="mui-navigate-right">
						<img src="image/share.png" width="18px" />
						<span>我的提交</span>
					</a>
				</li>
			</ul>
			<ul class="mui-table-view" style="margin-top: 25px;">
				<li class="mui-table-view-cell">
					<a id="about" class="mui-navigate-right">
						<img src="image/Smile.png" width="18px" />
						<span>关于</span>
					</a>
				</li>
			</ul>
			<ul class="mui-table-view" style="margin-top: 25px;">
				<li class="mui-table-view-cell">
					<a id="exit" style="text-align: center;color: #007aff;">
						退出
					</a>
				</li>
			</ul>
			<ul class="mui-table-view" style="margin-top: 25px;">
				<li class="mui-table-view-cell">
					<a id="logout" style="text-align: center;color: #007aff;">
						注销账号
					</a>
				</li>
			</ul>
		</div>
		</style>
	</body>
	<script src="js/mui.min.js"></script>
	<script>
		var baseUrl = "http://123.206.87.22";
		var userName;
		var userClass;
		var companyId;
		var userId;
		var subsidiaryId;
		var supervisionCompanyId;
		var eduBadge;
		var testBadge;
		var dangerBadge;
		var instituteBadge;
		var specialStaffBadge;
		var dataBadge;
		var preplanBadge;
		var responsibilityBadge;
		var majorStaffBadge;
		mui.init({
			swipeBack: true //启用右滑关闭功能
		});

		mui.plusReady(function() {
			mui.oldBack = mui.back;
			var backButtonPress = 0;
			mui.back = function(event) {
				backButtonPress++;
				if(backButtonPress > 1) {
					plus.runtime.quit();
				} else {
					plus.nativeUI.toast('再按一次退出应用');
				}
				setTimeout(function() {
					backButtonPress = 0;
				}, 1000);
				return false;
			};
			var self = plus.webview.currentWebview();
			userName = self.userName;
			userClass = self.userClass;
			companyId = self.companyId;
			userId = self.userId;
			subsidiaryId = self.subsidiaryId;
			supervisionCompanyId = self.supervisionCompanyId;
			var request_url = baseUrl + "/user/responsibilityDangers?userId=" + userId;
			var headers = {
				'Accept': 'application/json',
				'Content-Type': 'application/json;charset=utf-8',
			};
			mui.ajax(request_url, {
				type: "get",
				success: function(result) {
					var extend = eval(result.extend);
					var dangerList = extend.list;
					var res_num = localStorage.getItem("res");
					if(res_num == undefined || res == null)
						localStorage.setItem("res", dangerList.length);
					else {
						var num = dangerList.length - parseInt(res_num);
						localStorage.setItem("res", num);
						document.getElementById("res").innerHTML = num;
						if(num == 0)
							document.getElementById("res").style.display = "none";
					}
					if(dangerList.length == 0)
						document.getElementById("res").style.display = "none";
				},
				error: function() {
					plus.nativeUI.toast("请求失败!");
				}
			});
			if(userClass == "301") {
				var request_url = baseUrl + "/company/badge?companyId=" + companyId;
				console.log(request_url);
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						eduBadge = extend.eduBadge;
						testBadge = extend.testBadge;
						dangerBadge = extend.dangerBadge;
						instituteBadge = extend.instituteBadge;
						specialStaffBadge = extend.specialStaffBadge;
						dataBadge = extend.dataBadge;
						preplanBadge = extend.preplanBadge;
						responsibilityBadge = extend.responsibilityBadge;
						majorStaffBadge = extend.majorStaffBadge;
						document.getElementById("approve").style.display = "inline";
						document.getElementById("approve").innerHTML = dangerBadge + testBadge + eduBadge + instituteBadge + majorStaffBadge +
							responsibilityBadge + specialStaffBadge + preplanBadge;
						if((dangerBadge + testBadge + eduBadge + instituteBadge + majorStaffBadge +
								responsibilityBadge + specialStaffBadge + preplanBadge) <= 0){
							document.getElementById("approve").style.display = "none";
						}else{
							document.getElementById("approve").style.display = "inline";
						}
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			}
			if(userClass == "101") {
				var request_url = baseUrl + "/subsidiary/badge?subsidiaryId=" + subsidiaryId;
				console.log(request_url);
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						document.getElementById("approve").style.display = "none";
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			}
			else if(userClass == "201") {
				var request_url = baseUrl + "/supervisionCompany/badge?supervisionCompanyId=" + supervisionCompanyId + "&companyId=" + companyId;
				console.log(request_url);
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						eduBadge = extend.eduBadge;
						testBadge = extend.testBadge;
						dangerBadge = extend.dangerBadge;
						instituteBadge = extend.instituteBadge;
						specialStaffBadge = extend.specialStaffBadge;
						preplanBadge = extend.preplanBadge;
						responsibilityBadge = extend.responsibilityBadge;
						majorStaffBadge = extend.majorStaffBadge;
						document.getElementById("approve").style.display = "inline";
						document.getElementById("approve").innerHTML = dangerBadge + testBadge + eduBadge;
						if((testBadge + eduBadge + dangerBadge) <= 0){
							document.getElementById("approve").style.display = "none";
						}else{
							document.getElementById("approve").style.display = "inline";
						}
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			}
			else if(userClass == "401") {
				var request_url = baseUrl + "/director/badge?companyId=" + companyId;
				console.log(request_url);
				var headers = {
					'Accept': 'application/json',
					'Content-Type': 'application/json;charset=utf-8',
				};
				mui.ajax(request_url, {
					type: "get",
					success: function(result) {
						var extend = eval(result.extend);
						eduBadge = extend.eduBadge;
						testBadge = extend.testBadge;
						dangerBadge = extend.dangerBadge;
						instituteBadge = extend.instituteBadge;
						specialStaffBadge = extend.specialStaffBadge;
						preplanBadge = extend.preplanBadge;
						responsibilityBadge = extend.responsibilityBadge;
						majorStaffBadge = extend.majorStaffBadge;
						document.getElementById("approve").style.display = "inline";
						document.getElementById("approve").innerHTML = dangerBadge + testBadge + eduBadge + instituteBadge + majorStaffBadge +
							responsibilityBadge + specialStaffBadge + preplanBadge;
						if((dangerBadge +  testBadge + eduBadge + instituteBadge + majorStaffBadge +
								responsibilityBadge + specialStaffBadge + preplanBadge) <= 0){
							document.getElementById("approve").style.display = "none";
						}else{
							document.getElementById("approve").style.display = "inline";						
						}
					},
					error: function() {
						plus.nativeUI.toast("请求失败!");
					}
				});
			}
			else{
				document.getElementById("approve").style.display = "none";
			}
		});

		document.getElementById("exit").addEventListener('tap', function() {
			plus.runtime.quit();
		})

		document.getElementById("logout").addEventListener('tap', function() {
			localStorage.removeItem("username");
			localStorage.removeItem("pass");
			var all = plus.webview.all();
			console.log(all.length);
			for(var i = 0; i < all.length; i++) {
				console.log(all[i].id);
			}
			plus.webview.close("main");
			plus.webview.close("login");
			plus.webview.close("tab-webview-main.html");
			mui.fire(plus.webview.getWebviewById("HBuilder"), "refresh");
			plus.webview.close("tab-webview-subpage-my.html");
			plus.webview.close("tab-webview-subpage-focus.html");
			plus.webview.close(" tab-webview-subpage-activity.html");
			plus.webview.close(" tab-webview-subpage-project.html");
			plus.webview.close("tab-webview-subpage-my.html");
			plus.webview.close("tab-webview-subpage-focus.html");
			plus.webview.close(" tab-webview-subpage-activity.html");
			plus.webview.close(" tab-webview-subpage-project.html");
		})

		document.getElementById("myapprove").addEventListener("tap", function() {
			mui.openWindow({
				url: "new_approve.html",
				id: "new_approve",
				extras: {
					userId: userId,
					userClass: userClass,
					companyId: companyId,
					subsidiaryId: subsidiaryId,
					supervisionCompanyId: supervisionCompanyId
				}
			});
		});

		document.getElementById("myres").addEventListener("tap", function() {
			mui.openWindow({
				url: "my_responsibility.html",
				id: "my_responsibility.html",
				extras: {
					userId: userId,
					userClass: userClass,
					companyId: companyId,
					subsidiaryId: subsidiaryId,
					supervisionCompanyId: supervisionCompanyId
				}
			});
		});

		document.getElementById("mysub").addEventListener("tap", function() {
			mui.openWindow({
				url: "my_submit.html",
				id: "my_submit.html",
				extras: {
					userName: userName,
					userId: userId,
					userClass: userClass,
					companyId: companyId,
					subsidiaryId: subsidiaryId,
					supervisionCompanyId: supervisionCompanyId
				}
			});
		});

		window.addEventListener("refresh", function(event) {
			var li = document.getElementById(event.detail.id);
			if(event.detail.safe_num == undefined || event.detail.safe_num == "0") {
				li.style.display = "none";
				li.innerHTML = "0";
			} else {
				li.innerHTML = event.detail.safe_num;
			}
		});

		window.addEventListener("refresh_res", function() {
			var request_url = baseUrl + "/user/responsibilityDangers?userId=" + userId;
			var headers = {
				'Accept': 'application/json',
				'Content-Type': 'application/json;charset=utf-8',
			};
			mui.ajax(request_url, {
				type: "get",
				success: function(result) {
					var extend = eval(result.extend);
					var dangerList = extend.list;
					var user = "user" + userName;
					var res_num = localStorage.getItem(user);
					console.log(user);
					if(res_num == undefined || res_num == null)
						localStorage.setItem(user, dangerList.length);
					else {	
						var num = dangerList.length - parseInt(res_num);
						localStorage.setItem(user, dangerList.length);
						if(num <= 0){
							document.getElementById(user).style.display = "none";
						}else{
							document.getElementById(user).innerHTML = num;
						}
					}
					if(dangerList.length == 0)
						document.getElementById(user).style.display = "none";
				},
				error: function() {
					plus.nativeUI.toast("请求失败!");
				}
			});
		});
		
		window.addEventListener("refresh_main", function(){
				
		});		
	</script>

</html>